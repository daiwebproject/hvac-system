{{ define "content" }}
<div x-data="invoicePayment" class="min-h-screen bg-gray-50 flex flex-col pb-safe">
    <!-- Navbar -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-gray-100/50">
        <div class="px-4 py-3 flex items-center gap-3">
            <a href="javascript:history.back()" class="btn btn-sm btn-circle btn-ghost -ml-2 text-gray-600">
                <i class="fa-solid fa-arrow-left text-lg"></i>
            </a>
            <h1 class="font-bold text-gray-800 text-lg">Nghiệm thu & Thanh toán</h1>
        </div>
    </nav>

    <div class="flex-1 p-5 space-y-6 pb-32 max-w-lg mx-auto w-full">
        <!-- Unified Invoice Card -->
        <div class="card bg-white shadow-sm border border-gray-100 rounded-[24px]">
            <div class="p-5">
                <!-- Header Info -->
                <div class="flex justify-between items-center mb-4 border-b border-dashed border-gray-100 pb-4">
                    <div>
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">Mã HĐ</p>
                        <p
                            class="font-mono text-gray-600 font-bold bg-gray-100 px-2 py-0.5 rounded text-sm inline-block mt-1">
                            {{if .Invoice}}{{.Invoice.GetString "invoice_code"}}{{else}}PENDING{{end}}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-bold">Khách hàng</p>
                        <p class="font-bold text-gray-800 text-sm mt-1">{{.Job.GetString "customer_name"}}</p>
                    </div>
                </div>

                <!-- Detailed Items List -->
                <div class="space-y-3 mb-6">
                    <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wider flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-blue-500"></i> Chi tiết dịch vụ
                    </h3>

                    <div class="overflow-hidden rounded-xl border border-gray-100">
                        <table class="table table-xs w-full">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="pl-3 py-2">Hạng mục</th>
                                    <th class="text-center py-2">SL</th>
                                    <th class="text-right pr-3 py-2">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                {{ if .Items }}
                                {{ range .Items }}
                                <tr class="border-b border-gray-50 last:border-none">
                                    <td class="pl-3 py-2">
                                        <div class="font-medium">{{.GetString "item_name"}}</div>
                                    </td>
                                    <td class="text-center py-2">{{.GetInt "quantity"}}</td>
                                    <td class="text-right pr-3 py-2 font-mono">
                                        {{.GetFloat "total" | printf "%.0f" | formatMoney}}
                                    </td>
                                </tr>
                                {{ end }}
                                {{ else }}
                                <tr>
                                    <td colspan="3" class="text-center py-4 text-gray-400 text-sm">
                                        Chưa có chi tiết dịch vụ
                                    </td>
                                </tr>
                                {{ end }}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Total Amount -->
                <div class="bg-blue-50/50 rounded-2xl p-4 text-center border border-blue-100 mb-6">
                    <p class="text-xs text-blue-500 mb-1 font-bold uppercase tracking-wide">Tổng thanh toán</p>
                    {{ if .Invoice }}
                    <p class="text-3xl font-black text-blue-700 tracking-tight">
                        {{.Invoice.GetFloat "total_amount" | printf "%.0f" | formatMoney}} <span
                            class="text-lg text-blue-400 align-top">₫</span>
                    </p>
                    {{ else }}
                    <p class="text-red-500 font-bold">Chưa có hóa đơn</p>
                    {{ end }}
                </div>

                <!-- Signature Section -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center px-1">
                        <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-pen-nib text-orange-500"></i> Xác nhận & Ký tên
                        </h3>
                        <button type="button" @click="clearSignature()"
                            class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded-lg hover:bg-red-100 transition-colors">
                            Ký lại
                        </button>
                    </div>

                    <div
                        class="border-2 border-dashed border-gray-300 rounded-2xl bg-white touch-none relative overflow-hidden h-48 focus-within:border-blue-500 transition-colors">
                        <canvas id="signature-pad"
                            class="w-full h-full block cursor-crosshair active:cursor-grabbing"></canvas>
                        <div
                            class="absolute inset-0 pointer-events-none flex items-center justify-center text-gray-200 font-bold text-2xl opacity-30 uppercase tracking-widest select-none">
                            Ký vào đây
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 text-center italic mt-1">
                        Bằng việc ký tên, khách hàng xác nhận nghiệm thu công việc và đồng ý thanh toán.
                    </p>
                </div>
            </div>
        </div>

        <!-- Payment Method Selection -->
        <div class="card bg-white shadow-sm border border-gray-100 rounded-[24px]">
            <div class="p-4">
                <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wider mb-3 px-1">
                    Hình thức thanh toán
                </h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <label class="cursor-pointer">
                        <input type="radio" name="payment_method" value="transfer" class="peer sr-only"
                            x-model="method">
                        <div
                            class="rounded-xl border-2 border-transparent bg-gray-50 p-3 text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 hover:bg-gray-100">
                            <i class="fa-solid fa-qrcode text-xl mb-1 block"></i>
                            <span class="text-xs font-bold">Chuyển khoản (QR)</span>
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="payment_method" value="cash" class="peer sr-only" x-model="method">
                        <div
                            class="rounded-xl border-2 border-transparent bg-gray-50 p-3 text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:bg-gray-100">
                            <i class="fa-solid fa-money-bill-wave text-xl mb-1 block"></i>
                            <span class="text-xs font-bold">Tiền mặt</span>
                        </div>
                    </label>
                </div>

                <!-- METHOD SPECIFIC INPUTS -->
                <div x-show="method === 'transfer'" x-transition
                    class="space-y-4 p-4 bg-blue-50/50 rounded-xl border border-blue-100">

                    <!-- QR Code & Bank Info -->
                    <div class="text-center bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div class="mb-3">
                            <span class="badge badge-primary badge-outline text-xs font-bold px-3 py-2 bg-blue-50">Quét
                                mã để thanh toán</span>
                        </div>

                        <!-- Dynamic QR Code -->
                        {{ if .Invoice }}
                        {{ $bankBin := .Settings.BankBin }}
                        {{ $bankAccount := .Settings.BankAccount }}
                        {{ $qrTemplate := or .Settings.QrTemplate "compact" }}
                        {{ $amount := .Invoice.GetFloat "total_amount" | printf "%.0f" }}
                        {{ $invoiceCode := .Invoice.GetString "invoice_code" }}
                        <img src="https://img.vietqr.io/image/{{$bankBin}}-{{$bankAccount}}-{{$qrTemplate}}.png?amount={{$amount}}&addInfo=THANH%20TOAN%20{{$invoiceCode}}"
                            alt="QR Code Chuyển khoản"
                            class="w-48 h-48 mx-auto object-contain mb-3 border-2 border-dashed border-gray-200 rounded-lg p-2"
                            onerror="this.src='/assets/placeholder_qr.png'">
                        {{ else }}
                        <div
                            class="w-48 h-48 mx-auto mb-3 flex items-center justify-center border-2 border-dashed border-red-200 rounded-lg bg-red-50 text-red-500 text-xs text-center p-2">
                            Chưa có hóa đơn để tạo mã QR
                        </div>
                        {{ end }}

                        <div class="space-y-1 text-sm">
                            {{ $bankOwner := or .Settings.BankOwner "CHUA CAP NHAT" }}
                            <p class="font-bold text-gray-800 uppercase">{{$bankOwner}}</p>
                            <div class="flex items-center justify-center gap-2 text-gray-600 font-mono bg-gray-50 py-1.5 px-3 rounded-lg mx-auto w-fit border border-gray-200 cursor-pointer active:scale-95 transition-transform"
                                @click="copyBankAccount()">
                                {{or .Settings.BankAccount "---"}} <i class="fa-regular fa-copy text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div class="form-control">
                        <label class="label py-1">
                            <span class="label-text-alt text-blue-800 font-bold">Mã giao dịch / Nội dung CK (Bắt
                                buộc)</span>
                        </label>
                        <input type="text" name="transaction_code" x-model="transactionCode"
                            x-init="transactionCode = '{{if .Invoice}}{{.Invoice.GetString " invoice_code"}}{{end}}'"
                            placeholder="VD: CK 150K..."
                            class="input input-sm input-bordered w-full focus:input-primary bg-white font-mono text-sm">
                        <label class="label py-0">
                            <span class="label-text-alt text-gray-400 text-[10px]">Nên dùng Mã HĐ làm nội dung CK</span>
                        </label>
                    </div>
                </div>

                <div x-show="method === 'cash'" x-transition
                    class="space-y-3 p-3 bg-green-50 rounded-xl border border-green-100">
                    <label class="cursor-pointer flex items-start gap-3">
                        <input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"
                            x-model="cashConfirmed">
                        <span class="text-xs text-green-900 font-medium leading-tight">
                            Tôi xác nhận đã nhận đủ
                            <span class="font-bold">{{if .Invoice}}{{.Invoice.GetFloat "total_amount" | printf "%.0f" |
                                formatMoney}}{{else}}0{{end}} ₫</span>
                            tiền mặt từ khách hàng.
                        </span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Bottom Action -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-gray-100 z-50 pb-safe">
        <form id="payment-form" action="/api/tech/job/{{.Job.Id}}/payment" enctype="multipart/form-data">
            <input type="hidden" name="payment_method" x-model="method">
            <!-- Included in form submit automatically by name attribute -->

            <button type="button" @click="submitPayment()" :disabled="!canSubmit"
                class="btn btn-primary w-full shadow-lg text-base font-bold rounded-xl h-12 normal-case tracking-wide disabled:bg-gray-300 disabled:text-gray-500 disabled:border-none">
                <i class="fa-solid fa-check-circle"></i> Hoàn thành đơn hàng
            </button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('invoicePayment', () => ({
            method: 'transfer',
            transactionCode: '',
            cashConfirmed: false,
            signaturePad: null,

            get canSubmit() {
                if (this.method === 'cash') {
                    return this.cashConfirmed;
                }
                if (this.method === 'transfer') {
                    // Require at least 3 chars for transaction code
                    return this.transactionCode && this.transactionCode.trim().length >= 3;
                }
                return false;
            },

            init() {
                const canvas = document.getElementById('signature-pad');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);

                this.signaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'rgba(255, 255, 255, 0)',
                    penColor: 'rgb(0, 0, 0)'
                });

                // Handle resize
                window.addEventListener('resize', () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    this.signaturePad.clear();
                });
            },

            clearSignature() {
                this.signaturePad.clear();
            },

            copyBankAccount() {
                const bankAccount = '{{.Settings.BankAccount}}';
                if (navigator.clipboard && bankAccount) {
                    navigator.clipboard.writeText(bankAccount).then(() => {
                        Swal.fire({
                            toast: true,
                            position: 'top',
                            icon: 'success',
                            title: 'Đã sao chép STK',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }).catch(() => {
                        Swal.fire('Lỗi', 'Không thể sao chép', 'error');
                    });
                }
            },

            submitPayment() {
                // Double check validation logic just in case
                if (!this.canSubmit) {
                    let msg = 'Vui lòng kiểm tra lại thông tin.';
                    if (this.method === 'cash') msg = 'Bạn chưa xác nhận đã nhận tiền.';
                    if (this.method === 'transfer') msg = 'Vui lòng nhập mã giao dịch hợp lệ.';

                    Swal.fire({ title: 'Thiếu thông tin!', text: msg, icon: 'warning' });
                    return;
                }

                if (this.signaturePad.isEmpty()) {
                    Swal.fire({
                        title: 'Thiếu chữ ký!',
                        text: 'Vui lòng đưa khách hàng ký xác nhận nghiệm thu.',
                        icon: 'warning',
                        confirmButtonText: 'Đã hiểu'
                    });
                    return;
                }

                // 2. Safe Base64 to Blob conversion (No fetch dataURL)
                const dataURL = this.signaturePad.toDataURL();
                const splitData = dataURL.split(',');
                const byteString = atob(splitData[1]);
                const mimeString = splitData[0].split(':')[1].split(';')[0];

                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], { type: mimeString });

                // 3. Submit
                const form = document.getElementById('payment-form');
                const formData = new FormData(form);
                formData.append('signature_file', blob, 'signature.png');

                Swal.fire({
                    title: 'Đang xử lý...',
                    text: 'Vui lòng đợi trong giây lát',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // Use 'action' attribute instead of 'hx-post'
                fetch(form.getAttribute('action'), { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            const invoiceUrl = window.location.origin + "/invoice/" + data.invoice_hash;
                            const zaloShareUrl = `https://zalo.me/share?url=${encodeURIComponent(invoiceUrl)}`;

                            Swal.fire({
                                title: 'Hoàn thành!',
                                icon: 'success',
                                html: `
                                    <div class="space-y-4 mt-2">
                                        <p class="text-sm text-gray-600">Đơn hàng đã được ghi nhận thành công.</p>
                                        
                                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                            <p class="text-xs text-gray-400 font-bold uppercase mb-2">Gửi hóa đơn cho Khách</p>
                                            
                                            <a href="${zaloShareUrl}" target="_blank" class="btn btn-info btn-sm w-full text-white mb-2 no-underline normal-case">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1200px-Icon_of_Zalo.svg.png" 
                                                     class="w-5 h-5 mr-1 bg-white rounded-full p-0.5">
                                                Gửi qua Zalo
                                            </a>
                                            
                                            <div class="join w-full">
                                                <input type="text" value="${invoiceUrl}" class="input input-xs input-bordered join-item w-full text-gray-500" readonly>
                                                <button onclick="if(navigator.clipboard){navigator.clipboard.writeText('${invoiceUrl}'); this.innerHTML='<i class=\'fa-solid fa-check\'></i>'}" class="btn btn-xs join-item btn-square">
                                                    <i class="fa-regular fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <a href="/tech/jobs" class="btn btn-outline btn-sm w-full">
                                            <i class="fa-solid fa-home"></i> Về trang chủ
                                        </a>
                                    </div>
                                `,
                                showConfirmButton: false,
                                allowOutsideClick: false
                            });
                        } else {
                            Swal.fire('Lỗi', data.error || 'Có lỗi xảy ra', 'error');
                        }
                    })
                    .catch(err => {
                        Swal.fire('Lỗi kết nối', err.message, 'error');
                    });
            }
        }));
    });
</script>
{{ end }}