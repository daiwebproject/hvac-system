{{ define "content" }}
<div x-data="jobDetail({
        id: '{{.Job.Id}}',
        lat: {{.Job.GetFloat " lat"}}, long: {{.Job.GetFloat "long" }}, address: {{printf "%q"
    (.Job.GetString "address_details" )}}, status: '{{.Job.GetString "job_status"}}' })"
    class="bg-gray-50 min-h-screen pb-32">

    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/tech/jobs" class="btn btn-sm btn-circle btn-ghost">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>
                <h1 class="font-bold text-lg text-gray-800">Chi tiết công việc</h1>
            </div>
            <span class="badge font-bold uppercase text-[10px] tracking-wider" :class="{
                'badge-warning': status === 'pending' || status === 'assigned',
                'badge-primary': status === 'moving',
                'badge-secondary': status === 'working',
                'badge-success': status === 'completed',
                'badge-ghost': status === 'cancelled'
            }" x-text="getStatusLabel(status)"></span>
        </div>


        {{template "tech/status_stepper" .}}
    </nav>

    <div class="max-w-lg mx-auto p-4 space-y-4">

        <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl overflow-hidden">
            <div class="p-5">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex gap-3">
                        <div
                            class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xl uppercase">
                            {{ slice (.Job.GetString "customer_name") 0 1 }}
                        </div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">{{.Job.GetString "customer_name"}}</h2>
                            <p class="text-gray-500 text-sm">{{.Job.GetString "customer_phone"}}</p>
                        </div>
                    </div>
                    <a href="tel:{{.Job.GetString " customer_phone"}}"
                        class="btn btn-circle btn-success btn-sm text-white shadow-lg">
                        <i class="fa-solid fa-phone"></i>
                    </a>
                </div>

                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                    <div class="flex gap-2 items-start">
                        <i class="fa-solid fa-location-dot text-red-500 mt-1"></i>
                        <p class="text-sm text-gray-700 font-medium leading-relaxed">
                            {{.Job.GetString "address_details"}}
                        </p>
                    </div>

                    <a :href="getMapLink()" target="_blank"
                        class="btn btn-outline btn-primary btn-sm w-full mt-3 gap-2 rounded-lg">
                        <i class="fa-solid fa-diamond-turn-right"></i> Dẫn đường (Google Maps)
                    </a>
                </div>
            </div>
        </div>

        <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl">
            <div class="p-5">
                <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider mb-3">Thông tin yêu cầu</h3>

                <div class="space-y-3">
                    <div class="flex justify-between border-b border-dashed pb-2">
                        <span class="text-gray-600">Dịch vụ</span>
                        <span class="font-bold text-blue-700">{{.Job.GetString "device_type"}} {{.Job.GetString
                            "brand"}}</span>
                    </div>
                    <div class="flex justify-between border-b border-dashed pb-2">
                        <span class="text-gray-600">Thời gian hẹn</span>
                        <span class="font-mono font-medium">{{.Job.GetString "booking_time"}}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block mb-1">Ghi chú / Sự cố:</span>
                        <div
                            class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm italic border border-yellow-100">
                            "{{.Job.GetString "issue_description"}}"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{ if eq (.Job.GetString "job_status") "completed" }}
        <div class="card bg-white shadow-sm border-t-4 border-success">
            <div class="card-body p-5 text-center">
                <i class="fa-solid fa-check-circle text-5xl text-success mb-2"></i>
                <h3 class="font-bold text-lg">Đã Hoàn Thành</h3>
                <p class="text-gray-500">Tổng thu:
                    <span class="font-bold text-primary">
                        {{ if .Invoice }}{{ printf "%.0f" (.Invoice.GetFloat "total_amount") }}{{ else }}0{{ end }}k
                    </span>
                </p>
            </div>
        </div>
        {{ end }}
    </div>

    {{ if ne (.Job.GetString "job_status") "completed" }}
    {{template "tech/job_actions_bar" dict "JobId" .Job.Id}}
    {{ end }}

    <!-- Cancel Modal -->
    <div x-show="showCancelModal" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
        @click.self="showCancelModal = false">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl" @click.stop>
            <h3 class="text-xl font-bold mb-4 text-gray-800">
                <i class="fa-solid fa-triangle-exclamation text-orange-500"></i> Báo cáo sự cố / Hủy
            </h3>
            <p class="text-sm text-gray-600 mb-4">Vui lòng chọn tình huống:</p>

            <select x-model="cancelReason" class="select select-bordered w-full mb-4">
                <option value="">-- Chọn lý do --</option>
                <option value="customer_not_home">Khách không có nhà (Cần ảnh)</option>
                <option value="reschedule">Khách hẹn lại lịch</option>
                <option value="customer_cancelled">Khách hủy yêu cầu</option>
                <option value="cannot_fix">Không thể sửa được</option>
                <option value="missing_parts">Thiếu linh kiện</option>
                <option value="other">Lý do khác</option>
            </select>

            <!-- Photo Evidence Input -->
            <div x-show="cancelReason === 'customer_not_home'" class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Chụp ảnh cửa nhà khách (*)</label>
                <input type="file" x-ref="evidenceInput" accept="image/*" capture="environment"
                    class="file-input file-input-bordered w-full" />
            </div>

            <!-- New Time Input -->
            <div x-show="cancelReason === 'reschedule'" class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Chọn thời gian mới (*)</label>
                <input type="datetime-local" x-model="newTime" class="input input-bordered w-full" />
            </div>

            <textarea
                x-show="cancelReason === 'other' || cancelReason === 'cannot_fix' || cancelReason === 'missing_parts'"
                x-model="cancelNote" class="textarea textarea-bordered w-full mb-4"
                placeholder="Nhập ghi chú cụ thể..."></textarea>

            <div class="flex gap-3 justify-end">
                <button @click="showCancelModal = false" class="btn btn-ghost">Đóng</button>
                <button @click="cancelJob()" :disabled="!cancelReason || loading" class="btn btn-error">
                    <span x-show="loading" class="loading loading-spinner loading-sm"></span>
                    <span x-text="cancelReason === 'reschedule' ? 'Đổi lịch' : 'Xác nhận hủy'"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function jobDetail(data) {
        return {
            id: data.id,
            lat: data.lat,
            long: data.long,
            address: data.address,
            status: data.status,
            loading: false,
            showCancelModal: false,
            cancelReason: '',
            cancelNote: '',
            newTime: '',

            // SỬA LỖI: Link Google Maps chuẩn (giống Admin Dashboard)
            getMapLink() {
                if (this.lat && this.long && this.lat !== 0) {
                    return `https://www.google.com/maps?q=${this.lat},${this.long}&z=17`;
                }
                return `https://www.google.com/maps?q=${encodeURIComponent(this.address)}`;
            },

            getStatusLabel(s) {
                const map = {
                    'pending': 'Chờ xử lý',
                    'assigned': 'Mới nhận',
                    'moving': 'Đang đi',
                    'working': 'Đang làm',
                    'completed': 'Hoàn thành',
                    'cancelled': 'Đã hủy'
                };
                return map[s] || s;
            },

            async updateStatus(newStatus) {
                if (!confirm('Xác nhận chuyển trạng thái?')) return;

                this.loading = true;
                const fd = new FormData();
                fd.append('status', newStatus);

                try {
                    // Gọi API (Phù hợp với Handler update status hiện tại)
                    const res = await fetch(`/api/tech/bookings/${this.id}/status`, {
                        method: 'POST',
                        body: fd
                    });

                    if (res.ok) {
                        this.status = newStatus;
                        // Scroll lên đầu trang để tech thấy status bar thay đổi
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        alert('Lỗi: Không thể cập nhật trạng thái');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Lỗi kết nối mạng');
                } finally {
                    this.loading = false;
                }
            },

            async cancelJob() {
                if (!this.cancelReason) {
                    alert('Vui lòng chọn lý do');
                    return;
                }

                if (this.cancelReason === 'customer_not_home') {
                    if (!this.$refs.evidenceInput.files.length) {
                        alert('Vui lòng chụp ảnh bằng chứng');
                        return;
                    }
                }

                if (this.cancelReason === 'reschedule' && !this.newTime) {
                    alert('Vui lòng chọn thời gian mới');
                    return;
                }

                this.loading = true;
                const fd = new FormData();
                fd.append('reason', this.cancelReason);
                fd.append('note', this.cancelNote);

                if (this.newTime) {
                    fd.append('new_time', this.newTime);
                }

                if (this.$refs.evidenceInput && this.$refs.evidenceInput.files.length > 0) {
                    fd.append('evidence', this.$refs.evidenceInput.files[0]);
                }

                try {
                    const res = await fetch(`/api/tech/bookings/${this.id}/cancel`, {
                        method: 'POST',
                        body: fd
                    });

                    if (res.ok) {
                        if (this.cancelReason === 'reschedule') {
                            alert('Đã đổi lịch thành công');
                        } else {
                            alert('Đã hủy công việc');
                        }
                        window.location.href = '/tech/jobs';
                    } else {
                        const errorText = await res.text();
                        try {
                            const errJson = JSON.parse(errorText);
                            alert('Lỗi: ' + (errJson.error || errJson.message));
                        } catch (e) {
                            alert('Lỗi: ' + errorText);
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert('Lỗi kết nối mạng');
                } finally {
                    this.loading = false;
                    this.showCancelModal = false;
                }
            }
        }
    }
</script>
{{ end }}