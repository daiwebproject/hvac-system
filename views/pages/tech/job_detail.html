{{define "content"}}
<div x-data="jobDetail({
        id: '{{.Job.Id}}',
        lat: {{.Job.GetFloat "lat"}},
        long: {{.Job.GetFloat "long"}},
        address: '{{.Job.GetString "address_details" | js}}', status: '{{.Job.GetString "job_status"}}'
    })" 
    class="bg-gray-50 min-h-screen pb-32"> <nav class="bg-white shadow-sm sticky top-0 z-50 px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="/tech/jobs" class="btn btn-sm btn-circle btn-ghost">
                <i class="fa-solid fa-arrow-left text-lg"></i>
            </a>
            <h1 class="font-bold text-lg text-gray-800">Chi tiết công việc</h1>
        </div>
        <span class="badge font-bold" :class="{
            'badge-warning': status === 'pending',
            'badge-info': status === 'assigned',
            'badge-primary': status === 'moving',
            'badge-secondary': status === 'working',
            'badge-success': status === 'completed'
        }" x-text="getStatusLabel(status)"></span>
    </nav>

    <div class="max-w-lg mx-auto p-4 space-y-4">

        <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl overflow-hidden">
            <div class="p-5">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex gap-3">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xl">
                            {{ slice (.Job.GetString "customer_name") 0 1 }}
                        </div>
                        <div>
                            <h2 class="font-bold text-lg text-gray-800">{{.Job.GetString "customer_name"}}</h2>
                            <p class="text-gray-500 text-sm">{{.Job.GetString "customer_phone"}}</p>
                        </div>
                    </div>
                    <a href="tel:{{.Job.GetString "customer_phone"}}" class="btn btn-circle btn-success btn-sm text-white shadow-lg">
                        <i class="fa-solid fa-phone"></i>
                    </a>
                </div>

                <div class="bg-gray-50 rounded-xl p-3 border border-gray-100">
                    <div class="flex gap-2 items-start">
                        <i class="fa-solid fa-location-dot text-red-500 mt-1"></i>
                        <p class="text-sm text-gray-700 font-medium leading-relaxed">
                            {{.Job.GetString "address_details"}}
                        </p>
                    </div>
                    
                    <a :href="getMapLink()" target="_blank" 
                       class="btn btn-outline btn-primary btn-sm w-full mt-3 gap-2 rounded-lg">
                        <i class="fa-solid fa-diamond-turn-right"></i> Dẫn đường (Google Maps)
                    </a>
                </div>
            </div>
        </div>

        <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl">
            <div class="p-5">
                <h3 class="font-bold text-gray-500 text-xs uppercase tracking-wider mb-3">Thông tin yêu cầu</h3>
                
                <div class="space-y-3">
                    <div class="flex justify-between border-b border-dashed pb-2">
                        <span class="text-gray-600">Dịch vụ</span>
                        <span class="font-bold text-blue-700">{{.Job.GetString "device_type"}}</span>
                    </div>
                    <div class="flex justify-between border-b border-dashed pb-2">
                        <span class="text-gray-600">Thời gian hẹn</span>
                        <span class="font-mono font-medium">{{.Job.GetString "booking_time"}}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block mb-1">Ghi chú / Sự cố:</span>
                        <div class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm italic border border-yellow-100">
                            "{{.Job.GetString "issue_description"}}"
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{ if eq (.Job.GetString "job_status") "completed" }}
        <div class="card bg-white shadow-sm border-t-4 border-success">
             <div class="card-body p-5 text-center">
                <i class="fa-solid fa-check-circle text-5xl text-success mb-2"></i>
                <h3 class="font-bold text-lg">Đã Hoàn Thành</h3>
                <p class="text-gray-500">Tổng thu: <span class="font-bold text-primary">{{ if .Invoice }}{{ formatMoney (.Invoice.GetFloat "total_amount") }}{{ end }} ₫</span></p>
             </div>
        </div>
        {{ end }}

    </div>

    {{ if ne (.Job.GetString "job_status") "completed" }}
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] z-40">
        <div class="max-w-lg mx-auto flex gap-3">
            
            <template x-if="status === 'assigned'">
                <button @click="updateStatus('moving')" class="btn btn-primary flex-1 shadow-lg text-lg animate-pulse">
                    <i class="fa-solid fa-motorcycle"></i> BẮT ĐẦU DI CHUYỂN
                </button>
            </template>

            <template x-if="status === 'moving'">
                <button @click="updateStatus('working')" class="btn btn-secondary flex-1 shadow-lg text-lg">
                    <i class="fa-solid fa-screwdriver-wrench"></i> ĐÃ ĐẾN & BẮT ĐẦU LÀM
                </button>
            </template>

            <template x-if="status === 'working'">
                <a href="/tech/job/{{.Job.Id}}/complete" class="btn btn-success text-white flex-1 shadow-lg text-lg">
                    <i class="fa-solid fa-clipboard-check"></i> HOÀN THÀNH & NGHIỆM THU
                </a>
            </template>

        </div>
    </div>
    {{ end }}
</div>

<script>
    function jobDetail(data) {
        return {
            id: data.id,
            lat: data.lat,
            long: data.long,
            address: data.address,
            status: data.status,
            loading: false,

            // Tạo link Google Maps chuẩn xác
            getMapLink() {
                if (this.lat && this.long) {
                    // Ưu tiên tọa độ
                    return `https://www.google.com/maps/search/?api=1&query=${this.lat},${this.long}`;
                }
                // Fallback sang địa chỉ text
                return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(this.address)}`;
            },

            getStatusLabel(s) {
                const map = {
                    'assigned': 'Mới nhận',
                    'moving': 'Đang đi',
                    'working': 'Đang làm',
                    'completed': 'Hoàn thành'
                };
                return map[s] || s;
            },

            async updateStatus(newStatus) {
                if(!confirm('Xác nhận chuyển trạng thái?')) return;
                
                this.loading = true;
                const fd = new FormData();
                fd.append('status', newStatus);

                try {
                    // Gọi API cập nhật trạng thái (Sử dụng HTMX hoặc Fetch)
                    // Ở đây dùng Fetch cho đơn giản trong Alpine
                    const res = await fetch(`/api/tech/job/${this.id}/status`, {
                        method: 'POST',
                        body: fd
                    });
                    
                    if(res.ok) {
                        this.status = newStatus;
                        // Reload nhẹ để cập nhật UI nếu cần
                        // location.reload(); 
                    } else {
                        alert('Lỗi cập nhật trạng thái');
                    }
                } catch(e) {
                    alert('Lỗi kết nối');
                } finally {
                    this.loading = false;
                }
            }
        }
    }
</script>
{{end}}