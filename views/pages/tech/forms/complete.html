{{define "content"}}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<div class="max-w-md mx-auto bg-gray-50 min-h-screen" x-data="jobCompletion({
         jobId: '{{.Booking.Id}}',
         laborPrice: {{.LaborPrice}}
     })">

    <div class="bg-blue-600 p-4 text-white flex items-center shadow-lg sticky top-0 z-40">
        <a href="/tech/job/{{.Booking.Id}}" class="mr-3 btn btn-ghost btn-sm btn-circle text-white">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="font-bold text-lg">Nghiệm thu & Thanh toán</h1>
    </div>

    <form @submit.prevent="submitForm" class="p-4 space-y-6 pb-32">

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-camera text-blue-500 mr-2"></i> Ảnh nghiệm thu <span class="text-red-500 ml-1">*</span>
            </h3>

            <div class="grid grid-cols-3 gap-3">
                <template x-for="(photo, index) in photos" :key="index">
                    <div class="relative aspect-square rounded-lg overflow-hidden border shadow-sm group">
                        <img :src="photo" class="w-full h-full object-cover">
                        <button type="button" @click="removePhoto(index)"
                            class="absolute top-1 right-1 bg-red-500/80 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md backdrop-blur-sm">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </template>

                <label
                    class="aspect-square rounded-lg border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 bg-gray-50 cursor-pointer transition active:scale-95">
                    <i class="fas fa-plus text-2xl mb-1"></i>
                    <span class="text-xs font-medium">Thêm ảnh</span>
                    <input type="file" accept="image/*" capture="environment" class="hidden" @change="addPhoto($event)">
                </label>
            </div>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-2"><i class="fa-solid fa-pen-to-square text-blue-500 mr-2"></i> Ghi
                chú kỹ thuật</h3>
            <textarea x-model="notes" rows="3"
                class="textarea textarea-bordered w-full focus:outline-none focus:border-blue-500"
                placeholder="Mô tả công việc đã làm..."></textarea>
        </div>

        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-4">
                <i class="fas fa-boxes-stacked text-blue-500 mr-2"></i> Vật tư sử dụng
            </h3>

            <div class="space-y-3 mb-4">
                <template x-for="(item, index) in parts" :key="index">
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="flex-1">
                            <div class="font-bold text-gray-800 text-sm" x-text="item.name"></div>
                            <div class="text-xs text-gray-500 font-mono mt-1" x-text="formatMoney(item.price) + ' đ'">
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            <div class="join border border-gray-300 rounded-lg bg-white h-8">
                                <button type="button" @click="updateQty(index, -1)"
                                    class="btn btn-xs btn-ghost join-item px-2">-</button>
                                <div class="join-item px-2 flex items-center text-sm font-bold w-8 justify-center border-x border-gray-200"
                                    x-text="item.qty"></div>
                                <button type="button" @click="updateQty(index, 1)"
                                    class="btn btn-xs btn-ghost join-item px-2">+</button>
                            </div>
                            <div class="font-bold text-blue-600 text-sm w-20 text-right"
                                x-text="formatMoney(item.price * item.qty)"></div>
                        </div>
                    </div>
                </template>

                <div x-show="parts.length === 0"
                    class="text-center py-4 text-gray-400 text-sm italic bg-gray-50 rounded-lg border border-dashed">
                    Chưa có vật tư nào được thêm
                </div>
            </div>

            <select x-model="selectedPartId" @change="addManualPart()" class="select select-bordered select-sm w-full">
                <option value="">+ Chọn vật tư từ danh sách...</option>
                {{range .Inventory}}
                <option value="{{.ID}}" data-price="{{.Price}}" data-name="{{.Name}}">
                    {{.Name}} - {{.Price}}đ
                </option>
                {{end}}
            </select>
        </div>

        <!-- Payment & Signature Section (Merged) -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-file-signature text-blue-500 mr-2"></i> Xác nhận & Thanh toán
            </h3>

            <!-- Signature Pad -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Chữ ký khách hàng <span
                        class="text-red-500">*</span></label>
                <div
                    class="border-2 border-gray-200 rounded-lg bg-[url('https://www.transparenttextures.com/patterns/graphy.png')] bg-gray-50 touch-none relative">
                    <canvas id="signature-pad" class="w-full h-48 block cursor-crosshair"></canvas>
                    <div class="absolute bottom-2 right-2 text-[10px] text-gray-300 pointer-events-none select-none">Ký
                        vào đây</div>
                </div>
                <div class="flex justify-end mt-2">
                    <button type="button" @click="clearSignature()"
                        class="btn btn-xs btn-ghost text-red-500 hover:bg-red-50">
                        <i class="fa-solid fa-eraser"></i> Xóa ký lại
                    </button>
                </div>
            </div>

            <!-- Payment Method -->
            <h4 class="font-bold text-sm text-gray-700 mb-2">Phương thức thanh toán:</h4>
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                <button type="button" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-200"
                    :class="paymentMethod === 'transfer' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    @click="paymentMethod = 'transfer'">
                    <i class="fa-solid fa-qrcode mr-1"></i> Chuyển khoản
                </button>
                <button type="button" class="flex-1 py-2 text-sm font-bold rounded-lg transition-all duration-200"
                    :class="paymentMethod === 'cash' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                    @click="paymentMethod = 'cash'">
                    <i class="fa-solid fa-money-bill mr-1"></i> Tiền mặt
                </button>
            </div>

            <!-- QR Code (Transfer) -->
            <div x-show="paymentMethod === 'transfer'" x-transition class="text-center space-y-4 mb-4">
                <div class="bg-white p-3 inline-block rounded-xl shadow-md border border-gray-100">
                    <!-- Dynamic QR: Account info hardcoded for now or passed from backend -->
                    <img :src="getQrUrl(grandTotal, 'Thanh toan Job {{.Booking.Id}}')"
                        class="w-48 h-48 object-contain rounded-lg">
                </div>
                <p class="text-xs text-gray-500">Quét mã để thanh toán</p>
            </div>

            <!-- Cash Info -->
            <div x-show="paymentMethod === 'cash'" x-transition
                class="text-center p-4 bg-green-50 rounded-lg border border-green-100 mb-4">
                <p class="text-green-700 text-sm font-bold">Thu tiền mặt trực tiếp từ khách</p>
            </div>
        </div>

        <div
            class="bg-white p-4 rounded-xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)] border border-gray-200 fixed bottom-0 left-0 right-0 z-[100] pb-safe">
            <div class="max-w-md mx-auto">
                <div class="space-y-2 mb-4 text-sm">
                    <div class="flex justify-between text-gray-600">
                        <span>Phí dịch vụ (Nhân công):</span>
                        <span class="font-mono" x-text="formatMoney(laborPrice)"></span>
                    </div>
                    <div class="flex justify-between text-gray-600">
                        <span>Tổng tiền vật tư:</span>
                        <span class="font-mono" x-text="formatMoney(partsTotal)"></span>
                    </div>
                    <div class="divider my-1"></div>
                    <div class="flex justify-between text-lg font-black text-blue-700">
                        <span>TỔNG THANH TOÁN:</span>
                        <span x-text="formatMoney(grandTotal)"></span>
                    </div>
                </div>

                <button type="submit" :disabled="loading || photos.length === 0"
                    class="btn btn-primary w-full text-lg shadow-lg">
                    <span x-show="!loading"><i class="fas fa-check-circle mr-2"></i> HOÀN THÀNH CÔNG VIỆC</span>
                    <span x-show="loading" class="loading loading-spinner"></span>
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    function jobCompletion(initData) {
        return {
            jobId: initData.jobId,
            laborPrice: initData.laborPrice || 0,
            photos: [],
            notes: '',
            parts: [], // {id, name, price, qty}
            selectedPartId: '',
            loading: false,
            paymentMethod: 'transfer',
            signaturePad: null,

            init() {
                const canvas = document.getElementById('signature-pad');
                if (canvas) {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    this.signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,0)' });
                }
            },

            get partsTotal() {
                return this.parts.reduce((sum, item) => sum + (item.price * item.qty), 0);
            },
            get grandTotal() {
                return this.laborPrice + this.partsTotal;
            },

            addPhoto(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => this.photos.push(e.target.result);
                reader.readAsDataURL(file);
            },

            removePhoto(index) {
                this.photos.splice(index, 1);
            },

            addManualPart() {
                if (!this.selectedPartId) return;
                const select = document.querySelector('select[x-model="selectedPartId"]');
                const option = select.options[select.selectedIndex];
                const name = option.getAttribute('data-name');
                const price = parseFloat(option.getAttribute('data-price'));

                this.addPartItem(this.selectedPartId, name, price);
                this.selectedPartId = '';
            },

            addPartItem(id, name, price) {
                const existing = this.parts.find(p => p.id === id);
                if (existing) {
                    existing.qty++;
                } else {
                    this.parts.push({ id, name, price, qty: 1 });
                }
            },

            // --- ĐÃ SỬA: Thêm hàm updateQty bao bọc logic ---
            updateQty(index, change) {
                const item = this.parts[index];
                if (!item) return;

                item.qty += change;

                if (item.qty <= 0) {
                    this.parts.splice(index, 1);
                }
            },
            // ------------------------------------------------

            clearSignature() {
                if (this.signaturePad) this.signaturePad.clear();
            },

            getQrUrl(amount, info) {
                const bankBin = '970422'; // MBBank
                const accountNo = '0333666999';
                return `https://img.vietqr.io/image/${bankBin}-${accountNo}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(info)}`;
            },

            async submitForm() {
                if (this.photos.length === 0) {
                    alert('Vui lòng chụp ít nhất 1 ảnh nghiệm thu!');
                    return;
                }

                if (this.signaturePad && this.signaturePad.isEmpty()) {
                    alert('Vui lòng xin chữ ký khách hàng!');
                    return;
                }

                if (!confirm(`Xác nhận hoàn thành với tổng tiền ${this.formatMoney(this.grandTotal)}?`)) return;

                this.loading = true;

                const fd = new FormData();
                fd.append('notes', this.notes);
                fd.append('payment_method', this.paymentMethod);

                if (this.signaturePad) {
                    const sigData = this.signaturePad.toDataURL();
                    const res = await fetch(sigData);
                    const blob = await res.blob();
                    fd.append('signature_file', blob, 'signature.png');
                }

                for (let i = 0; i < this.photos.length; i++) {
                    const base64 = this.photos[i];
                    const res = await fetch(base64);
                    const blob = await res.blob();
                    const file = new File([blob], `photo_${i + 1}.jpg`, { type: 'image/jpeg' });
                    fd.append('after_images', file);
                }

                fd.append('parts_json', JSON.stringify(this.parts));

                try {
                    const res = await fetch(`/tech/job/${this.jobId}/complete`, {
                        method: 'POST',
                        body: fd
                    });

                    if (res.ok || res.redirected) {
                        window.location.href = res.url || '/tech/jobs';
                    } else {
                        const errorText = await res.text();
                        alert('Có lỗi xảy ra: ' + errorText);
                    }
                } catch (e) {
                    alert('Lỗi kết nối: ' + e.message);
                } finally {
                    this.loading = false;
                }
            },

            formatMoney(amount) {
                return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount).replace('₫', '');
            }
        }
    }
</script>
{{end}}