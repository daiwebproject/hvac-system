{{ define "content" }}
<link rel="stylesheet" href="/assets/vendor/leaflet/leaflet.css" />
<script src="/assets/vendor/leaflet/leaflet.js"></script>
<script src="/assets/js/services/map-tracking.js"></script>
<script src="/assets/js/services/tracking-integration.js"></script>

{{template "admin/stats_cards" .}}

<!-- iOS Notification Panel -->
<div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-4 flex justify-between items-center">
    <div>
        <h3 class="font-bold text-sm text-gray-700"><i class="fa-solid fa-bell text-blue-500 mr-2"></i>Thông Báo Push
        </h3>
        <p class="text-xs text-gray-500 mt-1">Nhận thông báo đơn hàng mới ngay trên điện thoại</p>
    </div>
    <button id="btn-enable-notify" onclick="requestAdminPermission()" class="btn btn-sm btn-primary hidden gap-2">
        <i class="fa-solid fa-bell"></i> Bật thông báo
    </button>
</div>

{{ if or (not .Settings.CompanyName) (eq .Settings.CompanyName "HVAC SaaS System") }}
<div class="alert alert-error shadow-sm mb-6 rounded-lg border border-red-200">
    <i class="fa-solid fa-triangle-exclamation text-2xl"></i>
    <div>
        <h3 class="font-bold">Cấu hình chưa hoàn tất!</h3>
        <div class="text-xs">Vui lòng cập nhật thông tin doanh nghiệp (Tên, Logo, Ngân hàng) để hệ thống hoạt động.
        </div>
    </div>
    <a href="/admin/settings" class="btn btn-sm bg-white border-0 text-red-600 hover:bg-gray-100">Cấu hình ngay</a>
</div>
{{ end }}

<div x-data="kanbanBoard(window.initialBookings)" class="pb-20">

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-4 md:gap-6 items-start">

        <div class="xl:col-span-9 space-y-6">

            <div
                class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 bg-white p-3 md:p-4 rounded-xl shadow-sm border border-gray-100">
                <div>
                    <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                        <i class="fa-solid fa-layer-group text-blue-600 mr-2"></i> Tiến độ
                    </h2>
                    <p class="text-[10px] md:text-xs text-gray-500 mt-1 hidden sm:block">Kéo thả để cập nhật trạng thái
                        hoặc giao việc.</p>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <!-- Search Input -->
                    <div class="relative w-full sm:w-64">
                        <input type="text" x-model="searchQuery" placeholder="Tìm tên hoặc SĐT..."
                            class="input input-xs md:input-sm input-bordered w-full pl-8" />
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                        <button x-show="searchQuery" @click="searchQuery = ''"
                            class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="join flex-1 sm:flex-none">
                        <button class="btn btn-xs md:btn-sm btn-active join-item"><i
                                class="fa-solid fa-grip-vertical"></i>
                            <span class="hidden xs:inline">Kanban</span></button>
                        <button class="btn btn-xs md:btn-sm join-item bg-base-100"><i class="fa-solid fa-list"></i>
                            <span class="hidden xs:inline">List</span></button>
                    </div>
                    <label for="modal-create-job"
                        class="btn btn-xs md:btn-sm btn-primary gap-2 shadow-lg shadow-blue-500/30 ml-auto sm:ml-0">
                        <i class="fa-solid fa-plus"></i> <span>Tạo đơn</span>
                    </label>
                </div>
            </div>

            <div class="overflow-x-auto pb-4 custom-scrollbar h-[calc(100dvh-300px)] min-h-[500px]">
                <div class="flex gap-5 min-w-full w-max px-1">

                    <div
                        class="w-80 flex-shrink-0 flex flex-col bg-gray-50/50 rounded-xl border border-gray-200/60 max-h-full">
                        <div
                            class="p-3 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-gray-50/95 backdrop-blur z-10 rounded-t-xl">
                            <span class="font-bold text-gray-600 text-sm uppercase tracking-wide">Mới Tiếp Nhận</span>
                            <span class="badge badge-sm font-mono"
                                x-text="columns.pending.filter(j => matchesSearch(j)).length">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2" @dragover.prevent
                            @drop="drop($event, 'pending')">
                            <template x-for="job in columns.pending.filter(j => matchesSearch(j))" :key="job.id">
                                <div class="card bg-white shadow-sm border border-gray-100 hover:shadow-md transition-all group relative"
                                    draggable="true" @dragstart="dragStart($event, job)">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-yellow-400 rounded-l-md"></div>

                                    <div class="card-body p-3 pl-4 space-y-1.5">
                                        <!-- Header: Name + Time + Eye -->
                                        <div class="flex justify-between items-start">
                                            <div class="flex flex-col">
                                                <h3 class="font-bold text-sm text-gray-800 line-clamp-1"
                                                    x-text="job.customer"></h3>
                                                <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                                    <i class="fa-regular fa-clock"></i> <span
                                                        x-text="job.created"></span>
                                                </span>
                                            </div>
                                            <button @click="viewJob(job)"
                                                class="btn btn-ghost btn-xs text-gray-400 hover:text-blue-600">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                        </div>

                                        <!-- Phone clickable -->
                                        <a :href="'tel:' + job.phone"
                                            class="text-xs text-green-600 hover:underline flex items-center gap-1"
                                            x-show="job.phone">
                                            <i class="fa-solid fa-phone"></i>
                                            <span x-text="job.phone"></span>
                                        </a>

                                        <!-- Address with map link -->
                                        <a :href="job.lat && job.long ? 'https://www.google.com/maps?q=' + job.lat + ',' + job.long : '#'"
                                            target="_blank"
                                            class="text-xs text-blue-600 hover:underline flex items-center gap-1 line-clamp-1"
                                            x-show="job.address">
                                            <i class="fa-solid fa-location-dot"></i>
                                            <span x-text="job.address" class="truncate"></span>
                                        </a>

                                        <!-- Service & Assign Button -->
                                        <div
                                            class="flex justify-between items-center pt-1 border-t border-gray-50 mt-1">
                                            <span
                                                class="badge badge-xs badge-warning bg-yellow-50 text-yellow-700 border-yellow-200 line-clamp-1 truncate max-w-[120px]"
                                                x-text="job.service || 'Khác'"></span>
                                            <button type="button" @click="openAssignModal(job)"
                                                class="btn btn-xs btn-primary shadow-sm hover:shadow-md transition-shadow">
                                                Giao việc
                                            </button>
                                        </div>
                                        <!-- Time Slot -->
                                        <div class="text-[10px] bg-yellow-50 text-yellow-700 px-2 py-1 rounded font-medium border border-yellow-200 text-center"
                                            x-text="job.time || 'Chưa hẹn giờ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div
                        class="w-80 flex-shrink-0 flex flex-col bg-blue-50/30 rounded-xl border border-blue-100/60 max-h-full">
                        <div
                            class="p-3 border-b border-blue-100 flex justify-between items-center sticky top-0 bg-blue-50/95 backdrop-blur z-10 rounded-t-xl">
                            <span class="font-bold text-blue-700 text-sm uppercase tracking-wide">Đã Giao Thợ</span>
                            <span class="badge badge-sm badge-info text-white font-mono"
                                x-text="columns.assigned.filter(j => matchesSearch(j)).length">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-3" @dragover.prevent
                            @drop="drop($event, 'assigned')">
                            <template x-for="job in columns.assigned.filter(j => matchesSearch(j))" :key="job.id">
                                <div class="card bg-white shadow-sm border border-blue-100 cursor-move hover:shadow-md transition-all relative"
                                    draggable="true" @dragstart="dragStart($event, job)">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l-xl"></div>
                                    <div class="card-body p-3 pl-4 space-y-1.5">
                                        <div class="flex justify-between items-start">
                                            <div class="flex flex-col">
                                                <h3 class="font-bold text-sm text-gray-800 line-clamp-1"
                                                    x-text="job.customer">
                                                </h3>
                                                <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                                    <i class="fa-regular fa-clock"></i> <span
                                                        x-text="job.created"></span>
                                                </span>
                                            </div>
                                            <button @click="viewJob(job)"
                                                class="btn btn-ghost btn-xs text-gray-400 hover:text-blue-600">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                        </div>
                                        <!-- Phone clickable -->
                                        <a :href="'tel:' + job.phone"
                                            class="text-xs text-green-600 hover:underline flex items-center gap-1"
                                            x-show="job.phone">
                                            <i class="fa-solid fa-phone"></i>
                                            <span x-text="job.phone"></span>
                                        </a>
                                        <!-- Address with map link -->
                                        <a :href="job.lat && job.long ? 'https://www.google.com/maps?q=' + job.lat + ',' + job.long : '#'"
                                            target="_blank"
                                            class="text-xs text-blue-600 hover:underline flex items-center gap-1 line-clamp-1"
                                            x-show="job.address">
                                            <i class="fa-solid fa-location-dot"></i>
                                            <span x-text="job.address" class="truncate"></span>
                                        </a>
                                        <!-- Technician assigned -->
                                        <div
                                            class="flex items-center gap-2 bg-blue-50 p-1.5 rounded-lg border border-blue-100">
                                            <div class="avatar placeholder">
                                                <div
                                                    class="bg-blue-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px]">
                                                    <i class="fa-solid fa-user-gear"></i>
                                                </div>
                                            </div>
                                            <span class="text-xs font-bold text-blue-800"
                                                x-text="job.tech_name || 'Chưa định danh'"></span>
                                        </div>
                                        <!-- Time Slot -->
                                        <div class="text-[10px] bg-blue-50 text-blue-700 px-2 py-1 rounded font-medium border border-blue-200 text-center"
                                            x-text="job.time || 'Chưa hẹn giờ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div
                        class="w-80 flex-shrink-0 flex flex-col bg-purple-50/30 rounded-xl border border-purple-100/60 max-h-full">
                        <div
                            class="p-3 border-b border-purple-100 flex justify-between items-center sticky top-0 bg-purple-50/95 backdrop-blur z-10 rounded-t-xl">
                            <span class="font-bold text-purple-700 text-sm uppercase tracking-wide">Đang Thực
                                Hiện</span>
                            <span class="badge badge-sm badge-secondary text-white font-mono"
                                x-text="columns.working.filter(j => matchesSearch(j)).length">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-3" @dragover.prevent
                            @drop="drop($event, 'working')">
                            <template x-for="job in columns.working.filter(j => matchesSearch(j))" :key="job.id">
                                <div class="card bg-white shadow-sm border border-purple-100 cursor-move relative"
                                    draggable="true" @dragstart="dragStart($event, job)">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-purple-500 rounded-l-xl"></div>
                                    <div class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-ping">
                                    </div>
                                    <div class="card-body p-3 pl-4 space-y-1.5">
                                        <div class="flex justify-between items-start">
                                            <div class="flex flex-col">
                                                <h3 class="font-bold text-sm text-gray-800 line-clamp-1"
                                                    x-text="job.customer">
                                                </h3>
                                                <span class="text-[10px] text-gray-400 flex items-center gap-1">
                                                    <i class="fa-regular fa-clock"></i> <span
                                                        x-text="job.created"></span>
                                                </span>
                                            </div>
                                            <button @click="viewJob(job)"
                                                class="btn btn-ghost btn-xs text-gray-400 hover:text-purple-600 -mr-2 -mt-2">
                                                <i class="fa-solid fa-eye"></i>
                                            </button>
                                        </div>
                                        <!-- Phone clickable -->
                                        <a :href="'tel:' + job.phone"
                                            class="text-xs text-green-600 hover:underline flex items-center gap-1"
                                            x-show="job.phone">
                                            <i class="fa-solid fa-phone"></i>
                                            <span x-text="job.phone"></span>
                                        </a>
                                        <!-- Address with map link -->
                                        <a :href="job.lat && job.long ? 'https://www.google.com/maps?q=' + job.lat + ',' + job.long : '#'"
                                            target="_blank"
                                            class="text-xs text-blue-600 hover:underline flex items-center gap-1 line-clamp-1"
                                            x-show="job.address">
                                            <i class="fa-solid fa-location-dot"></i>
                                            <span x-text="job.address" class="truncate"></span>
                                        </a>
                                        <!-- Status label -->
                                        <p class="text-xs text-purple-600 font-bold" x-text="job.status_label"></p>
                                        <!-- Progress bar -->
                                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                            <div class="bg-purple-500 h-1.5 rounded-full animate-pulse"
                                                style="width: 60%">
                                            </div>
                                        </div>
                                        <!-- Time Slot -->
                                        <div class="text-[10px] bg-purple-50 text-purple-700 px-2 py-1 rounded font-medium border border-purple-200 text-center"
                                            x-text="job.time || 'Chưa hẹn giờ'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div
                        class="w-80 flex-shrink-0 flex flex-col bg-green-50/30 rounded-xl border border-green-100/60 max-h-full">
                        <div
                            class="p-3 border-b border-green-100 flex justify-between items-center sticky top-0 bg-green-50/95 backdrop-blur z-10 rounded-t-xl">
                            <span class="font-bold text-green-700 text-sm uppercase tracking-wide">Hoàn Thành</span>
                            <span class="badge badge-sm badge-success text-white font-mono"
                                x-text="columns.completed.filter(j => matchesSearch(j)).length">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-3" @dragover.prevent
                            @drop="drop($event, 'completed')">
                            <template x-for="job in columns.completed.filter(j => matchesSearch(j))" :key="job.id">
                                <div
                                    class="card bg-white shadow-sm border border-green-100 opacity-80 hover:opacity-100 transition-opacity">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-green-500 rounded-l-xl"></div>
                                    <div class="card-body p-3 pl-4">
                                        <div class="flex justify-between">
                                            <h3 class="font-bold text-sm text-gray-800 line-through decoration-gray-400"
                                                x-text="job.customer"></h3>
                                            <i class="fa-solid fa-circle-check text-green-500"></i>
                                        </div>
                                        <div class="mt-2 flex gap-2">
                                            <button @click="viewJob(job)"
                                                class="btn btn-xs btn-outline btn-success w-full">Xem lại</button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div
                        class="w-80 flex-shrink-0 flex flex-col bg-red-50/30 rounded-xl border border-red-100/60 max-h-full">
                        <div
                            class="p-3 border-b border-red-100 flex justify-between items-center sticky top-0 bg-red-50/95 backdrop-blur z-10 rounded-t-xl">
                            <span class="font-bold text-red-700 text-sm uppercase tracking-wide">Đã Hủy</span>
                            <span class="badge badge-sm badge-error text-white font-mono"
                                x-text="columns.cancelled.filter(j => matchesSearch(j)).length">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-3" @dragover.prevent
                            @drop="drop($event, 'cancelled')">
                            <template x-for="job in columns.cancelled.filter(j => matchesSearch(j))" :key="job.id">
                                <div
                                    class="card bg-white shadow-sm border border-red-100 grayscale opacity-60 hover:grayscale-0 hover:opacity-100 transition-all">
                                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-500 rounded-l-xl"></div>
                                    <div class="card-body p-3 pl-4">
                                        <h3 class="font-bold text-sm text-gray-800 line-through" x-text="job.customer">
                                        </h3>
                                        <p
                                            class="text-xs text-red-500 font-bold mt-1 bg-red-50 inline-block px-1 rounded">
                                            <i class="fa-solid fa-ban mr-1"></i> <span
                                                x-text="job.cancel_reason || 'Đã hủy'"></span>
                                        </p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                </div>
            </div>
            <div class="card bg-white shadow-sm border border-gray-100 p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700 uppercase text-sm"><i class="fa-solid fa-chart-line mr-2"></i>
                        Doanh thu tuần</h3>
                    <select class="select select-bordered select-xs select-ghost">
                        <option>7 ngày qua</option>
                        <option>Tháng này</option>
                    </select>
                </div>
                <div class="h-64 w-full">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

        </div>
        <div class="xl:col-span-3 space-y-6">

            <div class="card bg-white shadow-sm border border-gray-100 overflow-hidden group"
                x-data="adminLocationMonitoring()" @init="init()">
                <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-sm"><i
                            class="fa-solid fa-map-location-dot text-blue-500 mr-2"></i> Bản đồ thợ</h3>
                    <div class="flex gap-1">
                        <button class="btn btn-xs btn-ghost text-blue-600" @click="fitBounds()">Center</button>
                        <button class="btn btn-xs btn-primary gap-1" @click="openMapModal()">
                            <i class="fa-solid fa-expand"></i> Mở rộng
                        </button>
                    </div>
                </div>
                <div class="relative h-64 w-full bg-gray-100">
                    <div id="admin-map" class="absolute inset-0 z-0"></div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-0 text-gray-400 text-xs"
                        x-show="!map">
                        Loading Map...
                    </div>
                </div>
            </div>

            <div class="card bg-white shadow-sm border border-gray-100">
                <div class="p-3 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-bolt text-yellow-500 mr-2"></i>
                        Công cụ nhanh</h3>
                </div>
                <ul class="menu w-full p-2 text-sm text-gray-600">
                    <li><a href="/admin/tools/slots" class="hover:text-blue-600 hover:bg-blue-50"><i
                                class="fa-solid fa-calendar-days w-5"></i> Quản lý Slot hẹn</a></li>
                    <li><a href="/admin/tools/inventory" class="hover:text-blue-600 hover:bg-blue-50"><i
                                class="fa-solid fa-boxes-stacked w-5"></i> Kho vật tư</a></li>
                    <li><a href="/admin/techs" class="hover:text-blue-600 hover:bg-blue-50"><i
                                class="fa-solid fa-users-gear w-5"></i> Danh sách thợ</a></li>
                </ul>
            </div>

            <div class="card bg-white shadow-sm border border-gray-100">
                <div class="p-3 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-trophy text-orange-500 mr-2"></i>
                        Top Thợ (Tuần)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="table table-xs w-full">
                        <thead>
                            <tr class="text-gray-400">
                                <th>Tên</th>
                                <th class="text-right">Đơn</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{ range .TopTechs }}
                            <tr class="hover:bg-gray-50">
                                <td class="font-medium">{{ .TechnicianName }}</td>
                                <td class="text-right font-bold text-blue-600">{{ .CompletedJobs }}</td>
                            </tr>
                            {{ else }}
                            <tr>
                                <td colspan="2" class="text-center text-gray-400 py-4 italic">Chưa có dữ liệu</td>
                            </tr>
                            {{ end }}
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div> <input type="checkbox" id="modal-create-job" class="modal-toggle" />
    <div class="modal" role="dialog">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-primary flex items-center"><i
                    class="fa-solid fa-file-circle-plus mr-2"></i>
                Tạo Đơn Hàng Mới</h3>
            <form id="create-job-form" class="mt-4 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label text-xs font-bold text-gray-500">Khách hàng <span
                                class="text-red-500">*</span></label>
                        <input type="text" name="customer_name" placeholder="Tên khách hàng"
                            class="input input-bordered input-sm w-full" required />
                    </div>
                    <div class="form-control">
                        <label class="label text-xs font-bold text-gray-500">Số điện thoại <span
                                class="text-red-500">*</span></label>
                        <input type="tel" name="customer_phone" placeholder="09xxx"
                            class="input input-bordered input-sm w-full" required />
                    </div>
                </div>
                <div class="form-control">
                    <label class="label text-xs font-bold text-gray-500">Địa chỉ</label>
                    <input type="text" name="address" placeholder="Số nhà, đường, phường..."
                        class="input input-bordered input-sm w-full" />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label text-xs font-bold text-gray-500">Dịch vụ</label>
                        <select name="service_id" class="select select-bordered select-sm w-full">
                            <option value="" disabled selected>-- Chọn --</option>
                            {{ range .Services }}
                            <option value="{{.Id}}">{{.GetString "name"}}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label text-xs font-bold text-gray-500">Hẹn lúc</label>
                        <input type="datetime-local" name="booking_time" class="input input-bordered input-sm w-full"
                            required />
                    </div>
                </div>
                <div class="form-control">
                    <label class="label text-xs font-bold text-gray-500">Ghi chú</label>
                    <textarea name="issue_description" class="textarea textarea-bordered h-20"
                        placeholder="Mô tả sự cố..."></textarea>
                </div>
                <div class="modal-action">
                    <label for="modal-create-job" class="btn btn-sm btn-ghost">Hủy</label>
                    <button type="button" @click="createJob()" class="btn btn-sm btn-primary">Tạo đơn</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Assignment Modal (Dynamic) -->
    <input type="checkbox" id="modal-assign-generic" class="modal-toggle" />
    <div class="modal" role="dialog">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Giao việc: <span x-text="selectedJob?.customer"></span></h3>
            <div>
                <div class="form-control w-full my-4">
                    <label class="label font-bold text-xs text-gray-500">Chọn kỹ thuật viên:</label>
                    <select x-model="assignTechId" class="select select-bordered w-full">
                        <option value="" disabled selected>-- Chọn người --</option>
                        <!-- Use x-for to handle dynamic availability -->
                        <template x-for="tech in techs" :key="tech.id">
                            <option :value="tech.id" :disabled="busyTechs[tech.id] || !tech.active"
                                x-text="tech.name + (busyTechs[tech.id] ? ' (⚠️ ' + busyTechs[tech.id] + ')' : '') + (!tech.active ? ' (Off)' : '')">
                            </option>
                        </template>
                    </select>
                    <label class="label text-xs text-orange-500" x-show="Object.keys(busyTechs).length > 0">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-triangle-exclamation"></i> Có thợ
                            trùng lịch với đơn này</span>
                    </label>
                </div>
                <div class="modal-action">
                    <label for="modal-assign-generic" class="btn btn-sm">Hủy</label>
                    <button type="button" class="btn btn-sm btn-primary" :disabled="!assignTechId"
                        @click="submitAssignment()">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>

    <input type="checkbox" id="modal-view-job" class="modal-toggle" />
    <div class="modal" role="dialog">
        <div class="modal-box max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-xl text-blue-800"><i class="fa-solid fa-circle-info mr-2"></i>Chi Tiết Đơn
                    Hàng</h3>
                <div class="badge badge-lg" :class="{
                    'badge-warning': selectedJob?.status == 'pending',
                    'badge-info': selectedJob?.status == 'assigned',
                    'badge-secondary': selectedJob?.status == 'working' || selectedJob?.status == 'moving',
                    'badge-success': selectedJob?.status == 'completed'
                }" x-text="selectedJob?.status_label"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 mb-4">
                <h4 class="font-bold text-lg" x-text="selectedJob?.customer"></h4>
                <p class="text-sm text-gray-500" x-text="selectedJob?.phone"></p>
                <div class="divider my-1"></div>
                <p class="text-sm mt-2 text-gray-700">
                    <i class="fa-solid fa-location-dot text-red-500 mr-2 w-4 text-center"></i>
                    <a :href="(selectedJob?.lat && selectedJob?.long) ? 'https://www.google.com/maps?q=' + selectedJob.lat + ',' + selectedJob.long + '&z=17' : 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(selectedJob?.address)"
                        target="_blank" class="hover:text-blue-600 hover:underline cursor-pointer"
                        title="Xem trên bản đồ">
                        <span x-text="selectedJob?.address"></span> <i
                            class="fa-solid fa-arrow-up-right-from-square text-xs ml-1 text-gray-400"></i>
                    </a>
                </p>
                <p class="text-sm mt-2 text-gray-700"><i
                        class="fa-solid fa-wrench text-blue-500 mr-2 w-4 text-center"></i>
                    <span x-text="selectedJob?.service"></span>
                </p>

                <div x-show="selectedJob?.status == 'cancelled'"
                    class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded border border-red-100">
                    <i class="fa-solid fa-ban mr-1"></i> Lý do hủy: <span class="font-bold"
                        x-text="selectedJob?.cancel_reason || 'Không có lý do'"></span>
                </div>

                <p class="text-sm mt-3 bg-white p-3 rounded-lg border border-gray-200 italic text-gray-600">
                    <i class="fa-solid fa-quote-left text-gray-300 mr-1"></i>
                    <span x-text="selectedJob?.issue"></span>
                </p>
            </div>

            <div class="modal-action flex justify-between mt-6">
                <button class="btn btn-error btn-outline btn-sm"
                    x-show="selectedJob?.status != 'cancelled' && selectedJob?.status != 'completed'"
                    @click="cancelJob(selectedJob.id)">Hủy đơn</button>
                <div class="flex gap-2 ml-auto">
                    <a x-show="selectedJob?.status == 'completed' && selectedJob?.invoice_hash"
                        :href="'/invoice/' + selectedJob?.invoice_hash" target="_blank"
                        class="btn btn-secondary btn-sm text-white">Xem Hóa Đơn</a>

                    <label for="modal-view-job" class="btn btn-neutral btn-sm">Đóng</label>
                </div>
            </div>
        </div>
        <label class="modal-backdrop" for="modal-view-job">Close</label>
    </div>

    <!-- Fullscreen Map Modal (INSIDE kanban component scope) -->
    <div class="modal" :class="showMapModal ? 'modal-open' : ''">
        <div class="modal-box w-11/12 max-w-7xl p-0 overflow-hidden flex flex-col" style="height: 90vh;">
            <!-- Header -->
            <div class="p-4 bg-white border-b flex justify-between items-center shadow-sm"
                style="flex-shrink: 0; height: 60px;">
                <h3 class="font-bold text-lg text-slate-800">
                    <i class="fa-solid fa-map-location-dot text-blue-500 mr-2"></i> Bản đồ Tổng hợp
                </h3>
                <div class="flex gap-2 items-center">
                    <!-- Legend -->
                    <div class="hidden sm:flex gap-3 text-xs">
                        <span class="flex items-center gap-1"><i class="fa-solid fa-circle text-yellow-500"></i> Chờ
                            xử</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-circle text-blue-500"></i> Đang
                            làm</span>
                        <span class="flex items-center gap-1"><i class="fa-solid fa-circle text-green-500"></i> Hoàn
                            thành</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-sm btn-outline btn-primary" @click.stop="toggleMapSidebar()">
                        <i class="fa-solid fa-list-ul mr-1"></i> Danh sách
                    </button>
                    <button class="btn btn-sm btn-circle btn-ghost" @click="closeMapModal()">✕</button>
                </div>
            </div>

            <!-- Main Content: Relative Container -->
            <div class="relative flex-1 overflow-hidden w-full h-full">

                <!-- Map Layer (Always Background) -->
                <div class="absolute inset-0 z-0">
                    <div id="fullscreen-map" class="w-full h-full bg-slate-100"></div>
                </div>

                <!-- Left Sidebar: Overlay -->
                <!-- Use transform to slide in/out. Default hidden on small screens? Or filtered? -->
                <!-- Plan: Default hidden. Toggle opens it. -->
                <div class="absolute top-2 left-2 bottom-2 w-80 bg-white shadow-xl rounded-lg border flex flex-col z-20 transition-all duration-300 transform"
                    :class="showMapSidebar ? 'translate-x-0 opacity-100 pointer-events-auto' : '-translate-x-full opacity-0 pointer-events-none'"
                    style="max-width: calc(100% - 16px);" @click.outside="showMapSidebar = false">

                    <!-- Sidebar Header (Mobile Close) -->
                    <div class="flex justify-between items-center p-2 border-b md:hidden">
                        <span class="font-bold text-sm">Danh sách</span>
                        <button class="btn btn-sm btn-circle btn-ghost" @click="showMapSidebar = false">✕</button>
                    </div>

                    <!-- Tab Buttons -->
                    <div class="flex border-b bg-gray-50">
                        <button @click="mapSidebarTab = 'techs'"
                            :class="mapSidebarTab === 'techs' ? 'border-b-2 border-blue-500 text-blue-600 bg-white font-semibold' : 'text-slate-500 hover:text-slate-700'"
                            class="flex-1 py-3 px-2 text-sm text-center transition">
                            <i class="fa-solid fa-user-tie mr-1"></i> Thợ (<span
                                x-text="techs.filter(t => t.active).length"></span>)
                        </button>
                        <button @click="mapSidebarTab = 'orders'"
                            :class="mapSidebarTab === 'orders' ? 'border-b-2 border-blue-500 text-blue-600 bg-white font-semibold' : 'text-slate-500 hover:text-slate-700'"
                            class="flex-1 py-3 px-2 text-sm text-center transition">
                            <i class="fa-solid fa-clipboard-list mr-1"></i> Đơn (<span
                                x-text="(columns.working?.length || 0) + (columns.pending?.length || 0) + (columns.assigned?.length || 0)"></span>)
                        </button>
                    </div>

                    <!-- Tab Content: Technicians -->
                    <div x-show="mapSidebarTab === 'techs'" class="overflow-y-auto flex-1 bg-white">
                        <template x-for="tech in techs" :key="tech.id">
                            <div class="p-3 border-b hover:bg-blue-50 cursor-pointer transition group"
                                @click="selectAndPanTo(tech.lat, tech.long, tech.id)" @mouseleave="techHoverOn = null"
                                :class="techHoverOn === tech.id ? 'bg-blue-100' : ''">
                                <div class="flex justify-between items-start gap-2">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="relative">
                                            <div
                                                class="w-10 h-10 rounded-full bg-gray-200 border-2 border-white shadow-sm overflow-hidden">
                                                <!-- Avatar placeholder or image if available -->
                                                <img :src="tech.avatar ? `/api/files/technicians/${tech.id}/${tech.avatar}` : 'https://ui-avatars.com/api/?name=' + tech.name"
                                                    class="w-full h-full object-cover">
                                            </div>
                                            <div class="absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-2 border-white"
                                                :class="tech.active ? 'bg-green-500' : 'bg-gray-400'"></div>
                                        </div>
                                        <div>
                                            <p class="font-bold text-sm text-slate-800 group-hover:text-blue-700 transition"
                                                x-text="tech.name"></p>
                                            <p class="text-[11px] text-slate-500 flex items-center gap-1">
                                                <i class="fa-solid fa-phone text-[10px]"></i>
                                                <span x-text="tech.phone"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold border"
                                            :class="getTechStatusClass(tech.status).replace('bg-', 'bg-opacity-20 border-').replace('text-', 'text-')"
                                            x-text="getTechStatusLabel(tech.status)">
                                        </span>
                                        <span class="text-[10px] text-slate-400" x-show="tech.distance">
                                            <i class="fa-solid fa-location-arrow mr-0.5"></i>
                                            <span x-text="Math.round(tech.distance) + 'km'"></span>
                                        </span>
                                    </div>
                                </div>
                                <!-- Expanded Info on Hover/Active -->
                                <div class="mt-2 text-xs text-slate-500 bg-slate-50 p-2 rounded flex justify-between items-center"
                                    x-show="getJobsForTech(tech.id).length > 0">
                                    <span><i class="fa-solid fa-briefcase text-blue-500 mr-1"></i> <span
                                            x-text="getJobsForTech(tech.id).length"></span> đơn đang nhận</span>
                                    <button class="text-blue-600 hover:underline font-medium"
                                        @click.stop="filterJobsByTech(tech.id)">Xem đơn</button>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Tab Content: Orders -->
                    <div x-show="mapSidebarTab === 'orders'" class="overflow-y-auto flex-1">
                        <template x-for="job in getAllJobs()" :key="job.id">
                            <div class="p-3 border-b hover:bg-blue-50 cursor-pointer transition group"
                                @click="highlightJobOnMap(job.id)" @mouseenter="jobHoverOn = job.id"
                                @mouseleave="jobHoverOn = null" :class="jobHoverOn === job.id ? 'bg-blue-100' : ''">
                                <div class="flex justify-between gap-2">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-bold text-sm text-slate-800 truncate"
                                                x-text="job.customer_name || job.customer"></span>
                                            <span class="text-[10px] px-1.5 rounded border"
                                                :class="job.status === 'priority' ? 'bg-red-50 text-red-600 border-red-200' : 'hidden'">Gấp</span>
                                        </div>
                                        <p class="text-[11px] text-slate-500 flex items-start gap-1">
                                            <i class="fa-solid fa-map-pin text-[10px] mt-0.5 text-red-400"></i>
                                            <span class="line-clamp-2"
                                                x-text="job.address || job.address_details || 'Chưa có địa chỉ'"></span>
                                        </p>
                                        <p class="text-[11px] text-slate-400 mt-1">
                                            <i class="fa-regular fa-clock mr-1"></i>
                                            <span x-text="job.time"></span>
                                        </p>
                                    </div>
                                    <div class="flex flex-col items-end gap-1 shrink-0">
                                        <span class="text-[10px] px-2 py-0.5 rounded-full font-bold" :class="job.status === 'completed' ? 'bg-green-100 text-green-700' : 
                                                   job.status === 'working' ? 'bg-purple-100 text-purple-700' : 
                                                   job.status === 'assigned' ? 'bg-blue-100 text-blue-700' : 
                                                   'bg-yellow-100 text-yellow-700'"
                                            x-text="getStatusLabel(job.status)">
                                        </span>
                                        <span class="text-[10px] text-blue-600 font-medium"
                                            x-text="job.service_type || job.service"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        <label class="modal-backdrop bg-slate-900/50 backdrop-blur-sm" @click="closeMapModal()"></label>
    </div>

</div>

<script>
    // [FIX] Khởi tạo dữ liệu JSON an toàn
    window.initialBookings = {{ .BookingsJSON }};
    window.initialTechs = {{ .TechniciansJSON }};

    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('revenueChart');
        if (!ctx) return;

        // Parse Go data
        const revenueData = [
            {{ range .RevenueStats }}
                { date: "{{.Date}}", amount: {{.Amount }} },
        {{ end }}
        ];
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: revenueData.map(d => d.date),
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: revenueData.map(d => d.amount),
                borderColor: '#2563eb',
                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: true, borderDash: [2, 2] } },
                x: { grid: { display: false } }
            }
        }
    });
    });
</script>

<style>
    /* Tùy chỉnh thanh cuộn cho Kanban */
    .custom-scrollbar::-webkit-scrollbar {
        height: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Map Modal Sidebar Scrollbar */
    .modal .w-80::-webkit-scrollbar {
        width: 6px;
    }

    .modal .w-80::-webkit-scrollbar-track {
        background: #f3f4f6;
    }

    .modal .w-80::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .modal .w-80::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Map Modal Enhanced */
    .modal .modal-box {
        max-height: 90vh;
    }

    /* Leaflet Map fixes */
    #fullscreen-map {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
    }

    #fullscreen-map .leaflet-popup-content {
        margin: 0;
        font-size: 13px;
    }

    #fullscreen-map .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
</style>
</style>

{{ end }}