{{ define "content" }}
<div class="max-w-4xl mx-auto py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Cài đặt Doanh nghiệp</h1>
            <p class="text-gray-500">Tùy chỉnh thông tin hệ thống, logo và tài khoản nhận tiền.</p>
        </div>
        <div>
            <!-- Actions if needed -->
        </div>
    </div>

    {{ if eq (index . "Success") "true" }} <!-- URL param checking done in template if passed, or js -->
    <!-- Ideally handler passes this or we check URL param via JS -->
    {{ end }}

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Main Settings Form -->
        <div class="md:col-span-2 space-y-6">
            <form action="/admin/settings" method="POST" enctype="multipart/form-data"
                class="card bg-base-100 shadow-xl">
                <input type="hidden" name="action" value="update_general">
                <div class="card-body">
                    <h2 class="card-title text-blue-800 border-b pb-2 mb-4">Thông tin chung</h2>

                    <!-- Company Name -->
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold">Tên công ty / Cửa hàng</span></label>
                        <input type="text" name="company_name" value="{{.Settings.CompanyName}}"
                            class="input input-bordered w-full" placeholder="Ví dụ: ĐIỆN LẠNH ABC" required />
                    </div>

                    <!-- Hotline -->
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold">Hotline</span></label>
                        <input type="text" name="hotline" value="{{.Settings.Hotline}}"
                            class="input input-bordered w-full" placeholder="0909.xxx.xxx" />
                    </div>

                    <!-- Logo -->
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold">Logo (Ảnh vuông tốt nhất)</span></label>
                        <div class="flex items-center gap-4">
                            {{ if .Settings.Logo }}
                            <div class="avatar">
                                <div class="w-16 rounded shadow border">
                                    <img src="/api/files/settings/{{$.Settings.Id}}/{{.Settings.Logo}}" />
                                    <!-- Note: We need Settings Record ID for file URL, but Settings struct doesn't have ID field currently mapped? 
                                    Ah, SettingsRepo returns domain.Settings which DOESN'T have ID. 
                                    We might need access to raw ID or just rely on 'settings' collection name if single record? 
                                    PocketBase needs ID.
                                    Let's handle this in JS or assume hardcoded record ID if predictable? 
                                    Actually, the middleware injects 'Settings' which IS the struct. 
                                    We need the Record ID for the image URL.
                                    Solution: Add ID to Settings struct! 
                                    -->
                                </div>
                            </div>
                            {{ end }}
                            <input type="file" name="logo" class="file-input file-input-bordered w-full"
                                accept="image/*" />
                        </div>
                    </div>

                    <h2 class="card-title text-blue-800 border-b pb-2 mb-4 mt-8">Thông tin Ngân hàng (QR Code)</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Bank Bin -->
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text font-bold">Mã ngân hàng (Bin Code)</span>
                                <a href="https://vietqr.io/danh-sach-ngan-hang" target="_blank"
                                    class="label-text-alt link link-primary">Tra cứu</a>
                            </label>
                            <input type="text" name="bank_bin" value="{{.Settings.BankBin}}"
                                class="input input-bordered w-full" placeholder="VD: 970422 (MB)" required />
                        </div>

                        <!-- Account Number -->
                        <div class="form-control w-full">
                            <label class="label"><span class="label-text font-bold">Số tài khoản</span></label>
                            <input type="text" name="bank_account" value="{{.Settings.BankAccount}}"
                                class="input input-bordered w-full" required />
                        </div>
                    </div>

                    <!-- Account Owner -->
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold">Tên chủ tài khoản</span></label>
                        <input type="text" name="bank_owner" value="{{.Settings.BankOwner}}"
                            class="input input-bordered w-full uppercase" required />
                    </div>

                    <!-- QR Template -->
                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold">Mẫu QR (VietQR)</span></label>
                        <select name="qr_template" class="select select-bordered">
                            <option value="compact" {{if eq .Settings.QrTemplate "compact" }}selected{{end}}>Compact
                                (Gọn)</option>
                            <option value="compact2" {{if eq .Settings.QrTemplate "compact2" }}selected{{end}}>Compact 2
                            </option>
                            <option value="qr_only" {{if eq .Settings.QrTemplate "qr_only" }}selected{{end}}>QR Only
                            </option>
                            <option value="print" {{if eq .Settings.QrTemplate "print" }}selected{{end}}>Print</option>
                        </select>
                    </div>

                    <div class="card-actions justify-end mt-8">
                        <button type="submit" class="btn btn-primary btn-lg shadow-lg">
                            <i class="fa-solid fa-save"></i> Lưu Cài Đặt
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- License Info Sidebar -->
        <div class="space-y-6">
            <div class="card bg-base-100 shadow-xl border border-warning">
                <form action="/admin/settings" method="POST" class="card-body">
                    <input type="hidden" name="action" value="update_license">
                    <h2 class="card-title text-warning"><i class="fa-solid fa-crown"></i> Bản quyền</h2>
                    <div class="form-control w-full mb-2">
                        <label class="label"><span class="label-text font-bold text-gray-500">License
                                Key:</span></label>
                        <input type="text" name="license_key" value="{{.Settings.LicenseKey}}"
                            class="input input-bordered w-full font-mono text-sm" placeholder="Paste key here..." />
                    </div>

                    <div class="form-control w-full">
                        <label class="label"><span class="label-text font-bold text-gray-500">Ngày hết
                                hạn:</span></label>
                        <input type="text" value="{{.Settings.ExpiryDate}}"
                            class="input input-bordered w-full bg-gray-100 {{if .Settings.ExpiryDate}}text-red-600{{end}}"
                            disabled readonly />
                    </div>
                    <div class="card-actions mt-4">
                        <button type="submit" class="btn btn-sm btn-warning w-full">Cập nhật License</button>
                    </div>
                </form>
            </div>

            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-gray-700">Hướng dẫn</h2>
                    <ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
                        <li><strong>Logo:</strong> Nên dùng ảnh vuông, nền trong suốt (PNG), kích thước khoảng
                            200x200px.</li>
                        <li><strong>Mã ngân hàng:</strong> Tra cứu trên trang VietQR để lấy đúng mã Bin (VD: MBBank là
                            970422).</li>
                        <li><strong>Thay đổi:</strong> Có hiệu lực ngay lập tức trên toàn hệ thống (Web & App thợ).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple Toast for success
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'success',
            title: 'Đã lưu cài đặt thành công!',
            showConfirmButton: false,
            timer: 3000
        });
        // Remove param
        window.history.replaceState({}, document.title, window.location.pathname);
    }
</script>
{{ end }}