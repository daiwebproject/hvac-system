{{ define "tech/partials/schedule_list" }}
<div
    class="space-y-6 relative before:absolute before:inset-0 before:left-5 before:h-full before:w-0.5 before:bg-gray-200 before:content-[''] pb-24">
    {{ range $index, $item := .ScheduleItems }}
    <div class="relative pl-12 transition-all duration-300">
        <!-- Timeline Node -->
        <div
            class="absolute left-0 top-0 w-10 h-10 rounded-full border-4 border-white shadow-sm flex items-center justify-center z-10 
             {{if .IsCurrent}}bg-{{.StatusColor}}-500 text-white scale-110 ring-4 ring-{{.StatusColor}}-100{{else}}bg-gray-100 text-gray-400{{end}}">
            <i class="fa-solid {{.Icon}} text-xs"></i>
        </div>

        <!-- Card -->
        <div
            class="bg-white p-4 rounded-2xl shadow-sm border {{if .IsCurrent}}border-{{.StatusColor}}-200 ring-1 ring-{{.StatusColor}}-50{{else}}border-gray-100{{end}}">
            <div class="flex justify-between items-start mb-2">
                <div class="flex flex-col">
                    <span class="text-lg font-black text-{{if .IsCurrent}}{{.StatusColor}}-600{{else}}gray-500{{end}}">
                        {{.DisplayTime}}
                    </span>
                    <!-- Show Date if not today (simplified logic: just show raw date part or handle in backend) -->
                    <!-- Here we trust DisplayTime is time only, so we might want to show date from record -->
                    <span class="text-xs text-gray-400 font-medium">
                        {{ if gt (len (.GetString "booking_time")) 10 }}
                        {{ slice (.GetString "booking_time") 8 10 }}/{{ slice (.GetString "booking_time") 5 7 }}
                        {{ end }}
                    </span>
                </div>
                <span
                    class="badge badge-sm uppercase font-bold tracking-tighter {{if .IsCurrent}}badge-{{.StatusColor}} text-white{{else}}badge-ghost{{end}}">
                    {{.GetString "job_status"}}
                </span>
            </div>

            <h4 class="font-bold text-gray-800 leading-tight">{{.GetString "service_name"}}</h4>

            <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                <i
                    class="fa-solid fa-location-dot text-{{if .IsCurrent}}{{.StatusColor}}-400{{else}}gray-300{{end}}"></i>
                <span class="truncate">{{.GetString "address"}}</span>
            </div>

            <div class="mt-3 pt-3 border-t border-gray-50 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="avatar placeholder">
                        <div class="bg-gray-100 text-gray-500 rounded-full w-6 h-6">
                            <span class="text-xs">{{ slice (.GetString "customer_name") 0 1 }}</span>
                        </div>
                    </div>
                    <span class="text-xs font-medium text-gray-600 truncate max-w-[120px]">{{.GetString
                        "customer_name"}}</span>
                </div>

                <div class="flex gap-2">
                    <!-- Note Toggle -->
                    <button class="btn btn-xs btn-ghost btn-square text-gray-400"
                        onclick="document.getElementById('note-{{.Id}}').classList.toggle('hidden')">
                        <i class="fa-regular fa-note-sticky {{if .GetString " tech_notes"}}text-yellow-500{{end}}"></i>
                    </button>

                    {{if .IsCurrent}}
                    <a href="/tech/job/{{.Id}}" class="btn btn-xs btn-{{.StatusColor}} rounded-lg px-3 animate-pulse">
                        Xử lý ngay <i class="fa-solid fa-arrow-right ml-1"></i>
                    </a>
                    {{else}}
                    <a href="/tech/job/{{.Id}}"
                        class="btn btn-xs btn-ghost text-gray-400 hover:text-blue-600 rounded-lg">
                        Chi tiết
                    </a>
                    {{end}}
                </div>
            </div>

            <!-- Private Note Section (Hidden by default unless has content) -->
            <div id="note-{{.Id}}" class="{{if not (.GetString " tech_notes")}}hidden{{end}} mt-3 bg-yellow-50 p-3
                rounded-xl border border-yellow-100 relative group">
                <label class="text-[10px] font-bold text-yellow-600 uppercase tracking-wider mb-1 block">Ghi chú cá
                    nhân</label>
                <textarea
                    class="textarea textarea-ghost textarea-xs w-full p-0 bg-transparent focus:bg-transparent focus:outline-none text-gray-700 leading-relaxed min-h-[40px] resize-none"
                    placeholder="Nhập ghi chú (VD: Chờ vật tư, khách hẹn lại...)" name="note"
                    hx-post="/api/tech/job/{{.Id}}/note" hx-trigger="keyup changed delay:1s" hx-swap="none"
                    hx-indicator="#note-indicator-{{.Id}}">{{.GetString "tech_notes"}}</textarea>
                <div id="note-indicator-{{.Id}}" class="htmx-indicator absolute top-3 right-3">
                    <span class="loading loading-spinner loading-xs text-yellow-500"></span>
                </div>
                <div
                    class="absolute bottom-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                    <i class="fa-solid fa-check text-green-500 text-xs shadow-sm"></i>
                </div>
            </div>
        </div>
    </div>
    {{ else }}
    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-8 rounded-3xl border border-blue-100/50 text-center mx-4">
        <div
            class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm text-blue-400">
            <i class="fa-solid fa-calendar-check text-2xl"></i>
        </div>
        <h3 class="text-blue-900 font-bold text-lg">Lịch trình trống</h3>
        <p class="text-blue-600/70 text-sm mt-1">Bạn chưa có lịch hẹn nào sắp tới.</p>
    </div>
    {{ end }}
</div>
{{ end }}